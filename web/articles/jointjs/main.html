<!DOCTYPE html>
<html>
<head lang="zh-cn">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>译 JointJS API - 龙则的个人站点</title>
    <script>
        // 用户通过搜索引擎到文章详情页时，跳到首页并进行哈希路由
        var href = window.location.href.replace(/[^:|\/]\//,function (matchStr){
            return matchStr + 'index.html#!';
        });
        window.location.href = href.replace('/main.html', '');
    </script>
</head>
<body>
<header>
    <h1>
        龙则的个人站点
    </h1>
    <h2>
        戒躁，沉心研究业务与技术
    </h2>
</header>
<div>
    <h1 id="header-1">译 JointJS API</h1>
<blockquote>
<p>可视化是软件开发中的一种思路，我们渴望不写代码拖拖拽拽，点击配置就可以生成可运行的项目，这是一个非常好的愿景，但是到目前为止方案很多但效果却并没有得到预期。我觉得这样的现状和这类系统的定位有关，这种交互行形式只适合做组合型的系统，可被操作的元素较少，关系种类较少，配置项较少，元素的关系的组合较多，并且希望用图形的方式来展示这些关系或节点状态。jointJs提供了基本支持，是二次开发的一个很不错的选择，本文翻译一些官方资料，期间会夹杂一些我的理解和实现方案。</p>
</blockquote>
<h2 id="header-1-1">概述</h2>
<p>此文档针对开源框架 JointJS 的核心部分，如果你找的是 Rappid 的文档，请点击 <a href="http://www.jointjs.com/rappid/docs" target="_blank">这里</a>，Rappid 是在 JointJS 基础上进行扩展功能更为丰富的组合套件。</p>
<p>JointJS 向外暴露三个全局变量：<strong>joint</strong>、<strong>V</strong> 和 <strong>g</strong>。</p>
<p><code>joint</code> 下存放画示意图所需的全部对象，通过 <code>joint.version</code> 这个属性你可以知道当前使用的是哪一个版本 JointJS </p>
<p><code>v</code> 这一全局变量来自于一个轻量级被我们称作“Vectorizer”的 svg 框架，这个框架使操作 svg 变得更简单。JointJS 在内部使用这个框架，你一般不需要接触这个库，但是为了更好的使用 JointJS 了解一下这个库也是有益处的。</p>
<p><code>g</code> 这一全局变量也来自 JointJS 内部使用的一个轻量级库，此库提供了很多好用的集合运算函数。同样你可能接触不到此库，但是如果你的项目中有几何运算，你一定会发现它的好处。</p>
<h2 id="header-1-2">安装</h2>
<p>首先你需要有库核心文件(joint.js 和 joint.css，或者对应的压缩版)。然后你还需要 JointJS 的依赖库：jQuery、Backbone、Lodash。</p>
<p>你可以向下面这样将资源引入到你的页面中：</p>
<pre><code>&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;joint.css&quot; /&gt;
&lt;script src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;lodash.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;backbone-min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;joint.js&quot;&gt;&lt;/script&gt;
</code></pre><p>访问<a href="http://www.jointjs.com/download" target="_blank">下载页面</a>获取所需的文件。</p>
<h2 id="header-1-3">JOINT.DIA.ELEMENT</h2>
<h3 id="header-1-3-1">概述</h3>
<p><code>joint.dia.Element</code> 是图形元素的基类。它是 <a href="http://backbonejs.org/#Model" target="_blank">Backbone model</a> 模块，并添加了一些额外属性，第一个重要的属性就是每个元素都要有一个不重复的标识，这个标识被存储在 <code>id</code> 属性中。其他的属性可以被存放在下面三个组中：</p>
<p>Geometry(几何类属性)</p>
<p>元素的坐标以对象的形式被存储在 <code>position</code> 属性中，此对象包括两个属性 <code>x</code> 和 <code>y</code>，<code>position</code> 属性可以被初始化设置，也可以直接通过 Backbone 的 <code>get</code>/<code>set</code> 方法来获取/修改，还可通过下面的 <code>translate</code> 方法来修改。</p>
<p>旋转角度被存储在 <code>angle</code> 属性中，旋转的参照点始终是元素的中心，<code>angle</code> 属性同样可以被初始化设置，也可以直接通过 Backbone 的 <code>get</code>/<code>set</code> 方法来获取/修改，还可通过下面的 <code>rotate</code> 方法来修改。</p>
<p>元素的大小以对象的形式被存储在 <code>size</code> 属性中，此对象包括两个属性 <code>width</code> 和 <code>height</code>，<code>size</code> 属性同样可以被初始化设置，也可以直接通过 Backbone 的 <code>get</code>/<code>set</code> 方法来获取/修改，还可通过下面的 <code>resize</code> 方法来修改。</p>
<p>Presentation(外观类属性)</p>
<p>另外一个重要的属性是 <code>attrs</code>， <code>attrs</code> 是一个对象，其属性名是子元素的选择器，对应的值设置 svg 元素的属性从而改变元素的内容和外观，<a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute" target="_blank">这里</a>有 svg 元素属性列表。</p>
<p>需要重点注意，每一个通过 <code>joint.dia.Element</code> 定义的 svg 元素组合都要通过 <code>joint.dia.ElementView</code> 渲染到页面上。比如 <code>joint.shapes.basic.Rect</code> 元素组合(继承自<code>joint.dia.Element</code>) 在页面中表现如下：</p>
<pre><code>&lt;g class=&quot;rotatable&quot;&gt;&lt;g class=&quot;scalable&quot;&gt;&lt;rect/&gt;&lt;/g&gt;&lt;text/&gt;&lt;/g&gt;
</code></pre><p>然而为了为一个矩形子元素填充红色，我们还需要为 <code>attrs</code> 添加如下属性：</p>
<pre><code>rect: { fill: &#39;red&#39; }
</code></pre><p>在提一句不建议直接修改 <code>attrs</code> 属性对象，建议通过 <code>attr</code> 方法来修改。</p>
<p><code>z</code> 是一个特殊的属性，决定了子元素的层级遮盖关系，<code>z</code> 值大的元素在 <code>z</code> 值小的元素上面。</p>
<p>Nesting(关系)</p>
<p>最后两个重要属性是 <code>embeds</code> 和 <code>parent</code>，这两个属性用来定义元素的包含于被包含关系，<code>embeds</code> 定义包含哪些元素，其值是一个数组，存放被包含实例的 id。<code>parent</code> 存放父元素的 id，当父元素翻转的时候子元素跟着一起翻转。</p>
<p><strong>译者注</strong></p>
<p>所有的图形都继承自 <code>joint.dia.Element</code>，但 <code>joint.dia.Element</code> 并不能直接使用，需要将其包装成图形来使用。图形都被放在 <code>joint.shapes</code> 下，最基本的图形被放在 <code>joint.shapes.basic</code> 下。<code>joint.shapes.basic</code> 包含了矩形、圆、图片、文字等基本元素，可以像下面这样声明一个矩形：</p>
<pre><code>var rect = new joint.shapes.basic.Rect(...);
</code></pre><p>Demo <a href="./demo/joint-dia-element.html" target="_blank">joint-dia-element.html</a> 下有完整示例。</p>
<h3 id="header-1-3-2">translate</h3>
<p><code>element.translate(tx, [ty], [opt])</code></p>
<p>将一个元素在 x 轴方向移动 <code>tx</code> 像素，在 y 轴方向移动 <code>ty</code> 像素。<code>ty</code> 是一个可选参数，默认值为零。配置项参数 <code>opt</code> 可用来传递一些额外参数供监听事件 <code>&#39;change:position&#39;</code> 的回调函数来接收，<code>opt.transition</code> 可被用来设置过渡效果，而不是生硬的突然改变位置，配置详情见 <code>joint.dia.Element:transition</code>。可以用 <code>opt.restrictedArea</code> 配置将移动限制在一个区域内，像这样:</p>
<pre><code>{
    x: 0,
    y: 0,
    width: 500,
    height: 500
}
</code></pre><p>如果你想把它的移动方位限制在他的父元素中，只需要获取将父元素的 <code>BBox</code> 作为 <code>opt.restrictedArea</code> 的值，向下面这样：</p>
<pre><code>myElement.translate(50, 50, {
    restrictedArea: graph.getCell(myElement.get(&#39;parent&#39;)).getBBox() 
});
</code></pre><p>上面的代码保证在子元素不会移动到父元素外面，这种约束对其子元素同样生效。</p>
<p>译者注：</p>
<p><code>translate</code> 是基于当前位置做位置改变，坐标左上角是原点，水平向右是 x 轴正方向，竖直向下是 y 轴正方向，<code>translate</code> 的位置变化值可正可负，分别对应于想坐标轴正向移动和负向移动。参见我写的 <a href="./demo/translate.html" target="_blank">示例</a></p>
<h2 id="header-1-4">joint.dia.Link</h2>
<h3 id="header-1-4-1">概述</h3>
<p><strong>joint.dia.Link</strong>是线的基类，在 <a href="http://backbonejs.org/#Model" target="_blank">Backbone model</a> 的基础上添加一些重要属性，其中第一个不得不提的重要属性还是 id，其他的属性可以分为下面三类：</p>
<p><strong>Connections(连接信息)</strong></p>
<p>用 <code>source</code> 和 <code>target</code> 属性来定义线连接的起始元素，每个配置项如下面这样：</p>
<pre><code>{
    id: &lt;id of an element&gt;,
    selector: &lt;CSS selector&gt;,
    port: &lt;id of a port&gt;
}
</code></pre><p><code>id</code> 是元素模块的 ID；<code>selector</code> 是可选参数，定义连接到元素的子元素，匹配规则和 CSS 选择器一样；<code>port</code> 也是可选参数，定义连接的起始元素的位置。</p>
<p><strong>Presentation(外观类属性)</strong></p>
<p>一条线的外观取决于 <code>vertices</code>、<code>connector</code> 和 <code>router</code> 三个属性的设置。</p>
<p><code>vertices</code> 定义线所经过的点。</p>
<pre><code>link.get(&#39;vertices&#39;)
link.set(&#39;vertices&#39;, [{ x: 100, y: 120 }, { x: 150, y: 60 }])
</code></pre><p><code>router</code> 同样是定义线所经过的点，与 <code>vertices</code> 不同的是：<code>vertices</code> 由用户定义，而 <code>router</code> 是计算而来。<code>router</code> 有三个系统预设的值分别是：<code>manhattan</code>、<code>metro</code> 和 <code>orthogonal</code>。前两个被称作智能路径，会自动避开元素使线不和元素重叠。<code>orthogonal</code> 和 <code>manhattan</code> 使线只能以水平和竖直线段链接，<code>metro</code> 这个容许以斜线的方式链接。</p>
<pre><code>link.set(&#39;router&#39;, { name: &#39;manhattan&#39; });
link.set(&#39;router&#39;, { name: &#39;metro&#39; });
link.set(&#39;router&#39;, { name: &#39;orthogonal&#39; });
</code></pre><p>如果为了兼容旧版，可以设置 <code>manhattan</code> 为 <code>true</code>。</p>
<pre><code>// old approach
link.set(&#39;manhattan&#39;, true)
</code></pre><p><code>manhattan</code> 还有一些有用的配置项，用来配置路径的计算方式，这些配置放在 <code>args</code> 属性中，属性列表如下</p>
<ul>
<li><code>excludeTypes</code> </li>
</ul>
<p>示例：</p>
<pre><code>link.set(&#39;router&#39;, {
    name: &#39;manhattan&#39;,
    args: {
        startDirections: [&#39;top&#39;],
        endDirections: [&#39;bottom&#39;],
        excludeTypes: [&#39;myNamespace.MyCommentElement&#39;]
    }
});
</code></pre><h2 id="header-1-5">joint.dia.Graph</h2>
<h2 id="header-1-6">joint.dia.Paper</h2>
<h2 id="header-1-7">joint.dia.ElementView</h2>
<h2 id="header-1-8">joint.dia.LinkView</h2>
<h2 id="header-1-9">Special Attributes</h2>
<h2 id="header-1-10">Utility Functions</h2>
<h2 id="header-1-11">Vectorizer</h2>
<h2 id="header-1-12">Geometry</h2>
<h2 id="header-1-13">参考页面</h2>
<p><a href="http://www.jointjs.com/" target="_blank">官网</a></p>
<p><a href="http://www.jointjs.com/api" target="_blank">jointJs API</a></p>
<p><a href="http://www.jointjs.com/api#v" target="_blank">Vectorizer API</a></p>
<p><a href="http://www.jointjs.com/api#g" target="_blank">Geometry API</a></p>
<p><a href="https://github.com/clientIO/joint" target="_blank">github</a></p>

</div>
</body>
</html>